name: Build and Release PHP-SDK ZIP (with vendor)

on:
  push:
    tags:
      - "*"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect tag
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          TAG_STRIPPED="${TAG#v}"
          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "TAG_STRIPPED=$TAG_STRIPPED" >> $GITHUB_ENV

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.1"
          tools: composer:v2

      - name: Cache Composer downloads
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache/files
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.json') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Composer update (no-dev)
        run: |
          composer update \
            --no-dev \
            --prefer-dist \
            --no-interaction \
            --no-progress \
            --optimize-autoloader

      - name: Build release folder
        run: |
          RELEASE_DIR="paynl-sdk"
          rm -rf "${RELEASE_DIR}"
          mkdir -p "${RELEASE_DIR}"

          # Copy SDK source (adjust if your structure differs)
          cp -R src "${RELEASE_DIR}/" 2>/dev/null || true

          # Copy composer metadata (optional but useful)
          cp composer.json "${RELEASE_DIR}/"
          [ -f composer.lock ] && cp composer.lock "${RELEASE_DIR}/" || true

          # Copy vendor
          cp -R vendor "${RELEASE_DIR}/"

          # Optional: include docs/license
          [ -f README.md ] && cp README.md "${RELEASE_DIR}/" || true
          [ -f LICENSE ] && cp LICENSE "${RELEASE_DIR}/" || true

          # Safety cleanup (just in case)
          find "${RELEASE_DIR}" -name ".DS_Store" -delete || true

      - name: Make ZIP
        run: |
          ZIP_NAME="SDKv${TAG_STRIPPED}.zip"
          zip -r "${ZIP_NAME}" paynl-sdk \
            -x "*.DS_Store" \
               "*/.git*" \
               "*/.github/*"

      - name: Upload ZIP to Release
        uses: softprops/action-gh-release@v2
        with:
          files: SDKv${{ env.TAG_STRIPPED }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
